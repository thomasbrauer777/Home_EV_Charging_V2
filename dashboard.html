<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charge Share - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left h1 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header-left p {
            color: #666;
            font-size: 0.9em;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        /* Cards */
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Stats */
        .stat {
            margin: 15px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-unit {
            font-size: 0.5em;
            color: #999;
            margin-left: 5px;
        }

        /* Party Cards */
        .party-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .party-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .party-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .party-status.pending {
            background: #fee;
            color: #c33;
        }

        .party-status.paid {
            background: #efe;
            color: #3c3;
        }

        /* Chart */
        .chart-container {
            height: 250px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-top: 20px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px 4px 0 0;
            min-height: 5px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-label {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75em;
            color: #666;
            white-space: nowrap;
        }

        .chart-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75em;
            font-weight: 600;
            color: #667eea;
            white-space: nowrap;
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .tariff-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .tariff-high {
            background: #fbbf24;
            color: #78350f;
        }

        .tariff-low {
            background: #60a5fa;
            color: #1e3a8a;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-left h1 {
                font-size: 1.5em;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .table {
                font-size: 0.9em;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>‚ö° EV Charge Share</h1>
                <p id="installationName">Wird geladen...</p>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="logout()">Abmelden</button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="card">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 20px;">Daten werden geladen...</p>
            </div>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="mainContent" style="display: none;">
            
            <!-- Current Period Stats -->
            <div class="card">
                <h2>üìä Aktueller Abrechnungszeitraum</h2>
                <div class="grid">
                    <div class="stat">
                        <div class="stat-label">Gesamtverbrauch</div>
                        <div class="stat-value" id="totalKwh">0<span class="stat-unit">kWh</span></div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Gesamtkosten</div>
                        <div class="stat-value" id="totalCost">0.00<span class="stat-unit">CHF</span></div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Anzahl Ladevorg√§nge</div>
                        <div class="stat-value" id="chargeCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Parties -->
            <div>
                <h2 style="color: white; margin-bottom: 15px; padding-left: 10px;">üë• Kostenaufteilung</h2>
                <div class="grid" id="partiesContainer">
                    <!-- Dynamically filled -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="markAsPaid()" id="markAsPaidBtn">
                        ‚úÖ Als bezahlt markieren
                    </button>
                </div>
            </div>

            <!-- Chart -->
            <div class="card">
                <h2>üìà Verbrauch letzte 7 Tage</h2>
                <div class="chart-container" id="chartContainer"></div>
            </div>

            <!-- Charges History -->
            <div class="card">
                <h2>üìù Ladevorg√§nge Historie</h2>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Uhrzeit</th>
                                <th>Tarif</th>
                                <th>Verbrauch (kWh)</th>
                                <th>Kosten (CHF)</th>
                            </tr>
                        </thead>
                        <tbody id="chargesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Overview -->
            <div class="card">
                <h2>üí∞ Monatliche √úbersicht</h2>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Monat</th>
                                <th>Zahlungen</th>
                                <th>Verbrauch (kWh)</th>
                                <th>Gesamtkosten (CHF)</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTableBody"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://fgvjxgcgbdzuewukxedo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZndmp4Z2NnYmR6dWV3dWt4ZWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTE3MTksImV4cCI6MjA3OTk4NzcxOX0.DhWTfgz9nfpt1OHbUJiETWkIwVU4lk6FweEHZl0stDg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentInstallation = null;
        let parties = [];
        let charges = [];
        let paymentHistory = [];

        function checkLogin() {
            const session = localStorage.getItem('ev_charge_session');
            if (!session) {
                window.location.href = 'login.html';
                return null;
            }
            try {
                const sessionData = JSON.parse(session);
                if (new Date(sessionData.expires_at) <= new Date()) {
                    localStorage.removeItem('ev_charge_session');
                    window.location.href = 'login.html';
                    return null;
                }
                return sessionData.installation_id;
            } catch (e) {
                localStorage.removeItem('ev_charge_session');
                window.location.href = 'login.html';
                return null;
            }
        }

        async function loadData() {
            try {
                const { data: installation } = await supabase.from('installations').select('*').eq('installation_id', currentInstallation).single();
                document.getElementById('installationName').textContent = installation.location || installation.installation_id;

                const { data: partiesData } = await supabase.from('parties').select('*').eq('installation_id', currentInstallation).order('party_order');
                parties = partiesData || [];

                const { data: chargesData } = await supabase.from('charges').select('*').eq('installation_id', currentInstallation).order('date', { ascending: false });
                charges = chargesData || [];

                const { data: paymentsData } = await supabase.from('payment_history').select('*').eq('installation_id', currentInstallation).order('payment_date', { ascending: false });
                paymentHistory = paymentsData || [];

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                updateStats();
                renderParties();
                renderChart();
                renderChargesTable();
                renderMonthlyTable();
            } catch (error) {
                console.error('Error:', error);
                alert('Fehler beim Laden: ' + error.message);
            }
        }

        function updateStats() {
            const totalKwh = charges.reduce((sum, c) => sum + parseFloat(c.kwh), 0);
            const totalCost = charges.reduce((sum, c) => sum + (parseFloat(c.kwh) * parseFloat(c.price)), 0);
            document.getElementById('totalKwh').innerHTML = totalKwh.toFixed(2) + '<span class="stat-unit">kWh</span>';
            document.getElementById('totalCost').innerHTML = totalCost.toFixed(2) + '<span class="stat-unit">CHF</span>';
            document.getElementById('chargeCount').textContent = charges.length;
        }

        function renderParties() {
            const container = document.getElementById('partiesContainer');
            if (parties.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>Keine Parteien</p></div>';
                return;
            }
            const totalCost = charges.reduce((sum, c) => sum + (parseFloat(c.kwh) * parseFloat(c.price)), 0);
            const costPerParty = totalCost / parties.length;
            container.innerHTML = parties.map(party => `
                <div class="card party-card">
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${party.party_name}</h3>
                    <div class="stat">
                        <div class="stat-label">Anteil (${(100 / parties.length).toFixed(0)}%)</div>
                        <div class="stat-value">${costPerParty.toFixed(2)}<span class="stat-unit">CHF</span></div>
                    </div>
                    ${party.is_payer ? '<p style="color: #667eea; font-size: 0.9em; margin-top: 10px;">üí≥ Zahlt alle</p>' : ''}
                    <span class="party-status ${totalCost > 0 ? 'pending' : 'paid'}">${totalCost > 0 ? '‚ö†Ô∏è Ausstehend' : '‚úÖ Bezahlt'}</span>
                </div>
            `).join('');
        }

        function renderChart() {
            const container = document.getElementById('chartContainer');
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                const dayCharges = charges.filter(c => {
                    const cd = new Date(c.date);
                    cd.setHours(0, 0, 0, 0);
                    return cd.getTime() === date.getTime();
                });
                const totalKwh = dayCharges.reduce((sum, c) => sum + parseFloat(c.kwh), 0);
                last7Days.push({ kwh: totalKwh, day: date.toLocaleDateString('de-DE', { weekday: 'short' }) });
            }
            const maxKwh = Math.max(...last7Days.map(d => d.kwh), 1);
            container.innerHTML = last7Days.map(d => {
                const height = (d.kwh / maxKwh) * 100;
                return `<div class="chart-bar" style="height: ${height}%;">${d.kwh > 0 ? `<div class="chart-value">${d.kwh.toFixed(1)} kWh</div>` : ''}<div class="chart-label">${d.day}</div></div>`;
            }).join('');
        }

        function renderChargesTable() {
            const tbody = document.getElementById('chargesTableBody');
            if (charges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Keine Ladevorg√§nge</td></tr>';
                return;
            }
            tbody.innerHTML = charges.slice(0, 20).map(c => {
                const date = new Date(c.date);
                const cost = parseFloat(c.kwh) * parseFloat(c.price);
                return `<tr><td>${date.toLocaleDateString('de-CH')}</td><td>${date.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' })}</td><td><span class="tariff-badge tariff-${c.tariff}">${c.tariff === 'high' ? 'HT' : 'NT'}</span></td><td>${parseFloat(c.kwh).toFixed(2)}</td><td><strong>${cost.toFixed(2)}</strong></td></tr>`;
            }).join('');
        }

        function renderMonthlyTable() {
            const tbody = document.getElementById('monthlyTableBody');
            if (paymentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Noch keine Zahlungen</td></tr>';
                return;
            }
            const monthlyData = {};
            paymentHistory.forEach(p => {
                const date = new Date(p.payment_date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[key]) monthlyData[key] = { date, count: 0, totalKwh: 0, totalCost: 0 };
                monthlyData[key].count++;
                monthlyData[key].totalKwh += parseFloat(p.total_kwh);
                monthlyData[key].totalCost += parseFloat(p.total_cost);
            });
            const sorted = Object.entries(monthlyData).sort((a, b) => b[1].date - a[1].date);
            tbody.innerHTML = sorted.map(([_, data]) => {
                const monthName = data.date.toLocaleDateString('de-CH', { year: 'numeric', month: 'long' });
                return `<tr><td>${monthName}</td><td>${data.count}</td><td>${data.totalKwh.toFixed(2)}</td><td><strong>${data.totalCost.toFixed(2)}</strong></td></tr>`;
            }).join('');
        }

        async function markAsPaid() {
            if (charges.length === 0) {
                alert('Keine Ladevorg√§nge zum Abrechnen.');
                return;
            }
            const totalKwh = charges.reduce((sum, c) => sum + parseFloat(c.kwh), 0);
            const totalCost = charges.reduce((sum, c) => sum + (parseFloat(c.kwh) * parseFloat(c.price)), 0);
            const costPerParty = totalCost / parties.length;
            const message = `Als bezahlt markieren?\n\n` + parties.map(p => `${p.party_name}: CHF ${costPerParty.toFixed(2)}`).join('\n') + `\n\nGesamt: CHF ${totalCost.toFixed(2)}`;
            if (!confirm(message)) return;
            try {
                await supabase.from('payment_history').insert([{
                    installation_id: currentInstallation,
                    payment_date: new Date().toISOString(),
                    total_kwh: totalKwh,
                    total_cost: totalCost,
                    cost_per_party: costPerParty,
                    charge_count: charges.length
                }]);
                await supabase.from('charges').delete().eq('installation_id', currentInstallation);
                alert('‚úÖ Als bezahlt markiert!');
                location.reload();
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        function logout() {
            if (confirm('Abmelden?')) {
                localStorage.removeItem('ev_charge_session');
                window.location.href = 'login.html';
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            currentInstallation = checkLogin();
            if (currentInstallation) loadData();
        });
    </script>
</body>
</html>
